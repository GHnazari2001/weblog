{% load static %}

<!DOCTYPE html>
<html lang="fa" dir="rtl" >

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>وبلاگ من</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="{% static 'assets/img/favicon.png' %}" rel="icon">
  <link href="{% static 'assets/img/apple-touch-icon.png' %}" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Roboto:300,300i,400,400i,500,500i,700,700i&display=swap"
    rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="{% static 'assets/vendor/animate.css/animate.min.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/aos/aos.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/boxicons/css/boxicons.min.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/glightbox/css/glightbox.min.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/swiper/swiper-bundle.min.css' %}" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="{% static 'assets/css/style.css' %}" rel="stylesheet">
  <link href="{% static 'assets/css/rtl-custom.css' %}" rel="stylesheet">

  <!-- =======================================================
  * Template Name: Moderna
  * Updated: May 30 2023 with Bootstrap v5.3.0
  * Template URL: https://bootstrapmade.com/free-bootstrap-template-corporate-moderna/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="fixed-top d-flex align-items-center">
    <div class="container d-flex justify-content-between align-items-center">

      <div class="logo">
        <h1 class="text-light"><a href="index.html"><span>اطلس</span></a></h1>
        <!-- Uncomment below if you prefer to use an image logo -->
        <!-- <a href="index.html"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->
      </div>

      <nav id="navbar" class="navbar">
        <ul>
          <li><a href="{% url 'home' %}">خانه</a></li>
          <li> <a href="{% url 'about' %}">درباره ما</a></li>
          <li> <a href="{% url 'contact' %}">تماس با ما</a></li>
          
          {% if user.is_authenticated %}
          <li class="dropdown"><a href="#"><span>{{ user.username }}</span> <i class="bi bi-chevron-down"></i></a>
            <ul>
              <li><a href="{% url 'new_post' %}">اضافه کردن پست</a></li>
              <li><a href="{% url 'profile' %}">پروفایل</a></li>
              
              <hr class="dropdown">
              <li>
                <form action="{% url 'logout' %}" method="post" class="m-0">
                  {% csrf_token %}
                  <button type="submit" class="dropdown-item"  style="padding-right: 20px; padding-bottom: 10px;">خروج</button>
                </form>
              </li>
            </ul>
          </li>
          {% else %}
          <li class="dropdown"><a href="#"><span>کاربر</span> <i class="bi bi-chevron-down"></i></a>
            <ul>
              <li><a href="{% url 'login' %}">ورود</a></li>
              <li><a href="{% url 'signup' %}">ثبت نام</a></li>
            </ul>
          </li>
          {% endif %}
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav>
    </div>
  </header><!-- End Header -->

  <main  id="main">

    {% block content %}
    {% endblock content %}

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer" data-aos="fade-up" data-aos-easing="ease-in-out" data-aos-duration="500">


  
    <div class="footer-top">
      <div class="container">
        <div class="row">
    
          <div class="col-lg-4 col-md-6 footer-info">
            <h3>درباره اطلس</h3>
            <p>اطلس  فضایی برای اشتراک‌گذاری دانش و تجربه در حوزه‌های متنوع تکنولوژی، امنیت، آموزش و سبک زندگی است. ما تلاش می‌کنیم تا با ارائه محتوای کاربردی و به‌روز، شما را در مسیر یادگیری و آگاهی همراهی کنیم.</p>
            <div class="social-links mt-3">
              <a href="#" class="twitter"><i class="bx bxl-twitter"></i></a>
              <a href="#" class="facebook"><i class="bx bxl-facebook"></i></a>
              <a href="#" class="instagram"><i class="bx bxl-instagram"></i></a>
            </div>
          </div>
    
          <div class="col-lg-2 col-md-6 footer-links">
            <h4>لینک‌های سریع</h4>
            <ul>
              <li><i class="bx bx-chevron-right"></i> <a href="{% url 'home' %}">خانه</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="{% url 'about' %}">درباره ما</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="{% url 'contact' %}">تماس با ما</a></li>
            </ul>
          </div>
    
          <div class="col-lg-3 col-md-6 footer-links">
            <h4>پست‌های اخیر</h4>
            {# این کد فرض می‌کند که recent_posts از context_processor در دسترس است #}
            <ul>
              {% for post in recent_posts %}
                <li><i class="bx bx-chevron-right"></i> <a href="{{ post.get_absolute_url }}">{{ post.title }}</a></li>
              {% empty %}
                <li>پستی یافت نشد.</li>
              {% endfor %}
            </ul>
          </div>
    
          <div class="col-lg-3 col-md-6 footer-contact">
            <h4>تماس با ما</h4>
            <p>
              <strong>ایمیل:</strong> your-email@example.com<br>
            </p>
          </div>
    
        </div>
      </div>
    </div>
  
    <div class="container">
      <div class="copyright">
        &copy; کپی‌رایت <strong><span>Moderna</span></strong>. تمام حقوق محفوظ است.
      </div>
      <div class="credits">
        طراحی شده توسط <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>
  </footer>```

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="{% static 'assets/vendor/purecounter/purecounter_vanilla.js' %}"></script>
  <script src="{% static 'assets/vendor/aos/aos.js' %}"></script>
  <script src="{% static 'assets/vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'assets/vendor/glightbox/js/glightbox.min.js' %}"></script>
  <script src="{% static 'assets/vendor/isotope-layout/isotope.pkgd.min.js' %}"></script>
  <script src="{% static 'assets/vendor/swiper/swiper-bundle.min.js' %}"></script>
  <script src="{% static 'assets/vendor/waypoints/noframework.waypoints.js' %}"></script>
  <script src="{% static 'assets/vendor/php-email-form/validate.js' %}"></script>

  <!-- Template Main JS File -->
  <script src="{% static 'assets/js/main.js' %}"></script>

  {# Add this script at the bottom of templates/base.html, before the closing </body> tag #}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // پیدا کردن تمام بخش‌های لایک
        const likeSections = document.querySelectorAll('.like-section');
    
        likeSections.forEach(section => {
            const button = section.querySelector('.like-button');
            if (button) {
                button.addEventListener('click', function(event) {
                    event.preventDefault(); // جلوگیری از رفتار پیش‌فرض لینک
    
                    // ابتدا postId را از دیتا اتریبیوت می‌خوانیم
                    const postId = section.dataset.postId;
                    if (!postId) {
                        console.error('Post ID not found on the like section!');
                        return;
                    }
    
                    // تابع برای خواندن توکن CSRF
                    function getCookie(name) {
                        let cookieValue = null;
                        if (document.cookie && document.cookie !== '') {
                            const cookies = document.cookie.split(';');
                            for (let i = 0; i < cookies.length; i++) {
                                const cookie = cookies[i].trim();
                                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }
                    const csrftoken = getCookie('csrftoken');
    
                    // ارسال درخواست AJAX با استفاده از Fetch API
                    fetch(`/post/${postId}/like/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest', // برای اینکه جنگو بفهمد این یک درخواست AJAX است
                        },
                    })
                    .then(response => {
                        if (!response.ok) {
                            // اگر کاربر لاگین نکرده باشد، به صفحه لاگین هدایت می‌شود
                            if (response.status === 403 || response.status === 401) {
                                window.location.href = "{% url 'login' %}?next=" + window.location.pathname;
                            }
                            throw new Error('Network response was not ok.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!data) return; // اگر پاسخی دریافت نشد، ادامه نده
    
                        // به‌روزرسانی تعداد لایک‌ها
                        const likeCountSpan = section.querySelector('.like-count');
                        if (likeCountSpan) {
                            likeCountSpan.textContent = data.likes_count;
                        }
    
                        // به‌روزرسانی آیکون قلب
                        const heartIcon = section.querySelector('.like-button i');
                        if (heartIcon) {
                            if (data.is_liked) {
                                heartIcon.classList.remove('bi-heart');
                                heartIcon.classList.add('bi-heart-fill');
                            } else {
                                heartIcon.classList.remove('bi-heart-fill');
                                heartIcon.classList.add('bi-heart');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                    });
                });
            }
        });
    });
    </script>

</body>

</html>